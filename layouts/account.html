{% extends 'layout_2.html'%}
{% block body %}

{% for category, message in get_flashed_messages(with_categories=true) %}
<script>
    Swal.fire({
        title: '{{ message }}',
        icon: '{{ "error" if category=="error" else "success" if category=="success" else "info" }}',
        timer: 3000,
        showConfirmButton: false
    });
</script>
{% endfor %}

<div class="col p-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-0">Cuentas de {{pla_name}}</h3>
            <small class="text-muted">Gestión de cuentas de la plataforma</small>
        </div>

        <div>
            <a href="{{url_for('platform.getPlatform')}}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i>
            </a>

            <button class="btn" style="background-color: rgba(4,17,43,0.92); color:white;" data-bs-toggle="modal"
                data-bs-target="#createModal">
                <i class="bi bi-plus-lg"></i> Nueva Cuenta
            </button>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card shadow border-0"  data-aos="zoom-in-up">
        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="table">
                    <thead>
                        <tr>
                            <th>Apodo</th>
                            <th>Proveedor</th>
                            <th>Fecha Pago</th>
                            <th>Email</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for acc in account %}
                        <tr>
                            <td>{{ acc[1] }}</td>
                            <td>{{ acc[2] }}</td>
                            <td>{{ acc[3] }}</td>
                            <td>{{ acc[4] if acc[4] else acc[5] }}</td>

                            <td>
                                {% if acc[7] == "enable" %}
                                <span class="badge bg-success">Activa</span>
                                {% else %}
                                <span class="badge bg-danger">Desactivada</span>
                                {% endif %}
                            </td>

                            <td class="text-end">

                                <!-- Perfiles -->
                                <a href="{{url_for('profile.getProfile', acc_id = acc[0])}}"
                                    class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-person-lines-fill"></i>
                                </a>

                                <!-- Editar -->
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                    data-bs-target="#editModal{{acc[0]}}">
                                    <i class="bi bi-pencil"></i>
                                </button>

                                <!-- Estado -->
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmState('{{acc[0]}}')">
                                    <i class="bi bi-power"></i>
                                </button>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

{% for acc in account %}

<!-- Modal Editar -->
<div class="modal fade" id="editModal{{acc[0]}}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Editar Cuenta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form action="{{url_for('account.putAccount', acc_id = acc[0])}}" method="post" id="form_upd{{acc[0]}}">

                <div class="modal-body row g-2">
                    <div class="col-md-4">
                        <label for="accnickname" class="form-label">Apodo*</label>
                        <input type="text" class="form-control" name="acc_nickname" id="accnickname" value="{{acc[1]}}"
                            required placeholder="La normal">

                    </div>
                    <div class="col-md-4">
                        <label for="accprovider" class="form-label">Proveedor*</label>
                        <input type="text" class="form-control" name="acc_provider" id="accprovider" value="{{acc[2]}}"
                            required placeholder="Yo mismo">

                    </div>
                    <div class="col-md-4">
                        <label for="accdatepay" class="form-label">Fecha de pago*</label>
                        <input type="date" class="form-control" name="acc_date_pay" id="accdatepay" value="{{acc[3]}}"
                            required>
                    </div>
                    <div class="col-md-6">
                        <label for="accemail" class="form-label">Correo*</label>
                        <input type="email" class="form-control" name="acc_email" id="accemail" value="{{acc[4]}}"
                            placeholder="plusgo.estreaming@gmail.com">
                    </div>
                    <div class="col-md-6">
                        <label for="accnumberphone" class="form-label">Numero de celular*</label>
                        <input type="tel" class="form-control" name="acc_number_phone" id="accnumberphone"
                            value="{{acc[5]}}" placeholder="3008000333">
                    </div>
                    <div class="col-12">
                        <label for="accpassword" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" name="acc_password" id="accpassword"
                            value="{{acc[6]}}" placeholder="******">
                    </div>
                    <input type="hidden" name="pla_id" id="" value="{{ request.view_args['pla_id'] }}">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn w-100" style="background-color: rgba(4,17,43,0.92); color: white;"
                        onclick="confirmUpdate('{{acc[0]}}')">
                        Guardar Cambios
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

{% endfor %}

<!-- Modal Crear -->
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Nueva Cuenta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form action="{{url_for('account.crtAccount')}}" method="post" id="form_crt">
                <div class="modal-body row g-2">
                    <div class="col-md-4">
                        {{form.hidden_tag()}}
                        <label for="accnickname" class="form-label">Apodo*</label>
                        {{form.accnickname(class="form-control mb-2", placeholder="La normal", id="accnickname")}}
                    </div>
                    <div class="col-md-4">
                        <label for="accprovider" class="form-label">Proveedor*</label>
                        {{form.accprovider(class="form-control mb-2", placeholder="Yo mismo", id="accprovider")}}
                    </div>
                    <div class="col-md-4">
                        <label for="accdatepay" class="form-label">Fecha de pago*</label>
                        {{form.accdatepay(class="form-control mb-2", id="accdatepay")}}
                    </div>
                    <div class="col-md-6">
                        <label for="accemail" class="form-label">Correo*</label>
                        {{form.accemail(class="form-control mb-2", placeholder="plusgo.estreaming@gmail.com",
                        id="accemail")}}
                    </div>
                    <div class="col-md-6">
                        <label for="accnumberphone" class="form-label">Numero de celular*</label>
                        {{form.accnumberphone(class="form-control mb-2", placeholder="3008000333",
                        id="accnumberphone")}}

                    </div>
                    <div class="col-12">
                        <label for="accpassword" class="form-label">Contraseña</label>
                        {{form.accpassword(class="form-control", placeholder="******", id="accpassword")}}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn w-100" style="background-color: rgba(4,17,43,0.92); color: white;"
                        onclick="confirmCreate()">
                        Crear Cuenta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script>
  AOS.init();
    function confirmUpdate(id) {
        Swal.fire({
            title: "¿Actualizar cuenta?",
            icon: "info",
            showCancelButton: true,
            confirmButtonColor: "rgba(4,17,43,0.92)",
            confirmButtonText: "Sí, guardar",
            cancelButtonText: "Cancelar"
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("form_upd" + id).submit();
            }
        });
    }

    function confirmCreate() {
        Swal.fire({
            title: "¿Crear cuenta?",
            icon: "info",
            showCancelButton: true,
            confirmButtonColor: "rgba(4,17,43,0.92)",
            confirmButtonText: "Sí, crear",
            cancelButtonText: "Cancelar"
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("form_crt").submit();
            }
        });
    }

    function confirmState(id) {
        Swal.fire({
            title: "¿Cambiar estado de la cuenta?",
            text: "Recuerda, no debe haber ninguna venta activa con esta cuenta",

            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            confirmButtonText: "Sí, cambiar",
            cancelButtonText: "Cancelar"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/account/state/" + id;
            }
        });
    }
    $(document).ready(function () {
        $('#table').DataTable({
            pageLength: 10,
            stateSave: true,
            order : [],
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
            },
            "columnDefs": [
                {
                    targets: [2], // Ajusta al índice de tu columna de fecha
                    render: function (data, type, row) {
                        if (type === 'display' && data) {
                            // Para formato ISO: "2024-01-15"
                            let partes = data.split('-');
                            if (partes.length === 3) {
                                return `${partes[2]}/${partes[1]}/${partes[0]}`; // DD/MM/YYYY
                            }
                        }
                        return data;
                    }
                },
            ]
        });
    });

</script>

{% endblock %}
